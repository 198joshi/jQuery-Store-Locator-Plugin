/*
* storeLocator v1.4 - jQuery Google Maps store locator plugin
* (c) Copyright 2012, Bjorn Holine (http://www.bjornblog.com)
* Released under the MIT license
* Distance calculation function by Chris Pietschmann: http://pietschsoft.com/post/2008/02/01/Calculate-Distance-Between-Geocodes-in-C-and-JavaScript.aspx
*/

(function(a){a.fn.storeLocator=function(b){var c=a.extend({mapDiv:"map",listDiv:"loc-list",formContainerDiv:"form-container",formID:"user-location",inputID:"address",zoomLevel:12,pinColor:"fe7569",pinTextColor:"000000",lengthUnit:"m",storeLimit:26,distanceAlert:60,dataType:"xml",dataLocation:"locations.xml",listColor1:"ffffff",listColor2:"eeeeee",originMarker:false,originpinColor:"blue",bounceMarker:true,slideMap:true,modalWindow:false,defaultLoc:false,defaultLat:"",defaultLng:"",autoGeocode:false,maxDistance:false,maxDistanceID:"maxdistance",fullMapStart:false,noForm:false,infowindowTemplatePath:"templates/infowindow-description.html",listTemplatePath:"templates/location-list-description.html",KMLinfowindowTemplatePath:"templates/kml-infowindow-description.html",KMLlistTemplatePath:"templates/kml-location-list-description.html",callbackBeforeSend:null,callbackComplete:null,callbackSuccess:null,callbackModalOpen:null,callbackModalClose:null},b);
return this.each(function(){var f=a(this);var q,n;if(c.dataType==="kml"){a.get(c.KMLlistTemplatePath,function(r){var y=r;q=Handlebars.compile(y);});a.get(c.KMLinfowindowTemplatePath,function(r){var y=r;
n=Handlebars.compile(y);});}else{a.get(c.listTemplatePath,function(r){var y=r;q=Handlebars.compile(y);});a.get(c.infowindowTemplatePath,function(r){var y=r;
n=Handlebars.compile(y);});}if(c.modalWindow===true){f.wrap('<div id="overlay"><div id="modal-window"><div id="modal-content">');a("#modal-window").prepend('<div id="close-icon"></div>');
a("#overlay").hide();}if(c.slideMap===true){f.hide();}var d,u,o,i,w,g;var l=new Array();var e={};if(c.lengthUnit==="km"){e.EarthRadius=6367;}else{e.EarthRadius=3956;
}e.ToRadian=function(r){return r*(Math.PI/180);};e.DiffRadian=function(y,r){return e.ToRadian(r)-e.ToRadian(y);};e.CalcDistance=function(B,A,z,y,r){return r*2*Math.asin(Math.min(1,Math.sqrt((Math.pow(Math.sin((e.DiffRadian(B,z))/2),2)+Math.cos(e.ToRadian(B))*Math.cos(e.ToRadian(z))*Math.pow(Math.sin((e.DiffRadian(A,y))/2),2)))));
};function t(){geocoder=new google.maps.Geocoder();this.geocode=function(r,y){geocoder.geocode({address:r},function(B,A){if(A==google.maps.GeocoderStatus.OK){var z={};
z.latitude=B[0].geometry.location.lat();z.longitude=B[0].geometry.location.lng();y(z);}else{alert("Geocode was not successful for the following reason: "+A);
y(null);}});};}function x(){geocoder=new google.maps.Geocoder();this.geocode=function(y,r){geocoder.geocode({latLng:y},function(B,A){if(A==google.maps.GeocoderStatus.OK){if(B[0]){var z={};
z.address=B[0].formatted_address;r(z);}}else{alert("Geocode was not successful for the following reason: "+A);r(null);}});};}function p(y,z){var r=Math.round(y*Math.pow(10,z))/Math.pow(10,z);
return r;}if(c.defaultLoc===true){var s=new x();var j=new google.maps.LatLng(c.defaultLat,c.defaultLng);s.geocode(j,function(y){if(y!==null){var r=y.address;
k(c.defaultLat,c.defaultLng,r);}else{alert("Unable to find address");}});}if(c.fullMapStart===true){k();}if(c.autoGeocode===true){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(m,v);
}}function m(y){var z=new x();var A=new google.maps.LatLng(y.coords.latitude,y.coords.longitude);z.geocode(A,function(B){if(B!==null){var r=B.address;k(y.coords.latitude,y.coords.longitude,r);
}else{alert("Unable to find address");}});}function v(r){alert("Automatic location detection failed. Please fill in your address or zip code.");}function h(A){var z=a("#"+c.formContainerDiv+" #"+c.inputID).val();
if(z===""){alert("The input box was blank.");}else{var y=new t();var r=z;y.geocode(r,function(B){if(B!==null){u=B.latitude;o=B.longitude;k(u,o,z,A);}else{alert("ERROR! Unable to geocode address");
}});}}a(function(){function r(z){z.preventDefault();if(c.maxDistance===true){var y=a("#"+c.formContainerDiv+" #"+c.maxDistanceID).val();h(y);}else{h();
}}if(c.noForm===true){a(document).on("click","#"+c.formContainerDiv+" #submit",function(y){r(y);});a(document).keyup(function(y){if(y.keyCode===13){r(y);
}});}else{a(document).on("submit","#"+c.formID,function(y){r(y);});}});function k(r,z,y,A){a(function(){var B;if(c.dataType==="kml"){B="xml";}else{B=c.dataType;
}a.ajax({type:"GET",url:c.dataLocation+(c.dataType==="jsonp"?(c.dataLocation.match(/\?/)?"&":"?")+"callback=?":""),dataType:B,beforeSend:function(){if(c.callbackBeforeSend){c.callbackBeforeSend.call(this);
}},complete:function(E,D,C){if(c.callbackComplete){c.callbackComplete.call(this,E,D,C);}},success:function(F,G,C){if(c.callbackSuccess){c.callbackSuccess.call(this,F,G,C);
}var E=0;var D=new Array();a("#"+c.mapDiv).addClass("mapOpen");if(c.dataType==="json"||c.dataType==="jsonp"){a.each(F,function(){var K=this.locname;var S=this.lat;
var T=this.lng;var U=this.address;var J=this.address2;var O=this.city;var I=this.state;var Q=this.postal;var R=this.phone;var P=this.web;P=P.replace("http://","");
var N=this.hours1;var M=this.hours2;var L=this.hours3;var H=e.CalcDistance(r,z,S,T,e.EarthRadius);if(c.maxDistance===true){if(H<A){D[E]=new Array(H,K,S,T,U,J,O,I,Q,R,P,N,M,L);
}else{return;}}else{D[E]=new Array(H,K,S,T,U,J,O,I,Q,R,P,N,M,L);}E++;});}else{if(c.dataType==="kml"){a(F).find("Placemark").each(function(){var I=a(this).find("name").text();
var K=a(this).find("coordinates").text().split(",")[1];var H=a(this).find("coordinates").text().split(",")[0];var J=a(this).find("description").text();
var L=e.CalcDistance(r,z,K,H,e.EarthRadius);if(c.maxDistance===true){if(L<A){D[E]=new Array(L,I,K,H,J);}else{return;}}else{D[E]=new Array(L,I,K,H,J);}E++;
});}else{a(F).find("marker").each(function(){var K=a(this).attr("name");var S=a(this).attr("lat");var T=a(this).attr("lng");var U=a(this).attr("address");
var J=a(this).attr("address2");var O=a(this).attr("city");var I=a(this).attr("state");var Q=a(this).attr("postal");var R=a(this).attr("phone");var P=a(this).attr("web");
P=P.replace("http://","");var N=a(this).attr("hours1");var M=a(this).attr("hours2");var L=a(this).attr("hours3");var H=e.CalcDistance(r,z,S,T,e.EarthRadius);
if(c.maxDistance===true){if(H<A){D[E]=new Array(H,K,S,T,U,J,O,I,Q,R,P,N,M,L);}else{return;}}else{D[E]=new Array(H,K,S,T,U,J,O,I,Q,R,P,N,M,L);}E++;});}}D.sort(function(J,I){var H=J[0];
var K=I[0];return((H<K)?-1:((H>K)?1:0));});if(c.maxDistance===true){if(D[0]===undefined||D[0][0]>A){alert("Unfortunately, our closest location is more than "+A+" miles away.");
return;}}else{if(D[0][0]>c.distanceAlert){alert("Unfortunately, our closest location is more than "+c.distanceAlert+" miles away.");}}a(function(){var ak,ac,aa,Y,O,af,I,ah,P,X,V,U,ae;
function Q(al){ak=D[al][0];ak=p(ak,2);ac=D[al][1];aa=D[al][4];Y=D[al][5];O=D[al][6];af=D[al][7];I=D[al][8];ah=D[al][9];P=D[al][10];X=D[al][11];V=D[al][12];
U=D[al][13];}function S(al){ak=D[al][0];ak=p(ak,2);ac=D[al][1];ae=D[al][4];}function J(ap){if(c.dataType==="kml"){S(ap.get("id"));}else{Q(ap.get("id"));
}var an;if(ak<=1){if(c.lengthUnit==="km"){an="kilometer";}else{an="mile";}}else{if(c.lengthUnit==="km"){an="kilometers";}else{an="miles";}}var ao=ap.get("id");
if(c.storeLimit>26){var am=ao+1;}else{var am=String.fromCharCode("A".charCodeAt(0)+ao);}if(c.dataType==="kml"){var al={location:[{distance:ak,markerid:ao,marker:am,name:ac,description:ae,length:an,origin:y}]};
}else{var al={location:[{distance:ak,markerid:ao,marker:am,name:ac,address:aa,address2:Y,city:O,state:af,postal:I,phone:ah,web:P,hours1:X,hours2:V,hours3:U,length:an,origin:y}]};
}return al;}if(c.slideMap===true){f.slideDown();}if(c.modalWindow===true){a("#overlay").fadeIn();a(document).on("click","#close-icon",function(){a("#overlay").hide();
});a(document).on("click","#overlay",function(){a("#overlay").hide();});a(document).on("click","#modal-window",function(al){al.stopPropagation();});a(document).keyup(function(al){if(al.keyCode===27){a("#overlay").hide();
}});}if(c.fullMapStart===true||c.zoomLevel===0){var Z={mapTypeId:google.maps.MapTypeId.ROADMAP};var M=new google.maps.LatLngBounds();}else{var Z={zoom:c.zoomLevel,center:new google.maps.LatLng(r,z),mapTypeId:google.maps.MapTypeId.ROADMAP};
}var ai=new google.maps.Map(document.getElementById(c.mapDiv),Z);var ag=new Array();var T=new google.maps.InfoWindow();if((D.length-1)<c.storeLimit-1){g=D.length-1;
}else{g=c.storeLimit-1;}if(c.originMarker===true&&c.fullMapStart===false){var L=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",new google.maps.Size(40,37),new google.maps.Point(0,0),new google.maps.Point(12,35));
var W=new google.maps.LatLng(r,z);var N=new google.maps.Marker({position:W,map:ai,icon:"http://maps.google.com/mapfiles/ms/icons/"+c.originpinColor+"-dot.png",shadow:L,draggable:false});
}for(var R=0;R<=g;R++){var aj=String.fromCharCode("A".charCodeAt(0)+R);var ad=new google.maps.LatLng(D[R][2],D[R][3]);N=H(ad,D[R][1],D[R][4],aj);N.set("id",R);
ag[R]=N;if(c.fullMapStart===true||c.zoomLevel===0){M.extend(ad);}K(N);}if(c.fullMapStart===true||c.zoomLevel===0){ai.fitBounds(M);}a("#"+c.listDiv+" ul").empty();
a(ag).each(function(al,am){var an=String.fromCharCode("A".charCodeAt(0)+al);var ao=ag[al];ab(ao);});function ab(am){var al=J(am);var an=q(al);a("#"+c.listDiv+" ul").append(an);
}a(document).on("click","#loc-list li",function(){var an=a(this).data("markerid");var am=ag[an];a("#"+c.listDiv+" li").removeClass("list-focus");a("#"+c.listDiv+" li[data-markerid="+an+"]").addClass("list-focus");
ai.panTo(am.getPosition());var al="left";if(c.bounceMarker===true){am.setAnimation(google.maps.Animation.BOUNCE);setTimeout(function(){am.setAnimation(null);
K(am,al);},700);}else{K(am,al);}});a("#"+c.listDiv+" ul li:even").css("background","#"+c.listColor1);a("#"+c.listDiv+" ul li:odd").css("background","#"+c.listColor2);
function H(al,ao,an,ar){var aq=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+ar+"|"+c.pinColor+"|"+c.pinTextColor,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));
var ap=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",new google.maps.Size(40,37),new google.maps.Point(0,0),new google.maps.Point(12,35));
if(c.storeLimit>26){var am=new google.maps.Marker({position:al,map:ai,draggable:false});}else{var am=new google.maps.Marker({position:al,map:ai,icon:aq,shadow:ap,draggable:false});
}return am;}function K(ao,an){var am=J(ao);var al=n(am);if(an==="left"){T.setContent(al);T.open(ao.get(c.mapDiv),ao);}else{google.maps.event.addListener(ao,"click",function(){T.setContent(al);
T.open(ao.get(c.mapDiv),ao);a("#"+c.listDiv+" li").removeClass("list-focus");markerId=ao.get("id");a("#"+c.listDiv+" li[data-markerid="+markerId+"]").addClass("list-focus");
var ap=a("#"+c.listDiv),aq=a("#"+c.listDiv+" li[data-markerid="+markerId+"]");a("#"+c.listDiv).animate({scrollTop:aq.offset().top-ap.offset().top+ap.scrollTop()});
});}}});}});});}});};})(jQuery);